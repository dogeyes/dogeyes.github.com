<link href="/assets/themes/twitter/css/pygments.css" rel="stylesheet">

<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>使用数据库 chapter23 LCLSS</title>
    <meta name="description" content="">
    <meta name="author" content="dogeyes">

    <!-- Enable responsive viewport -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- Le HTML5 shim, for IE6-8 support of HTML elements -->
    <!--[if lt IE 9]>
      <script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->

    <!-- Le styles -->
    <link href="/assets/themes/twitter/bootstrap/css/bootstrap.2.2.2.min.css" rel="stylesheet">
    <link href="/assets/themes/twitter/css/style.css?body=1" rel="stylesheet" type="text/css" media="all">

    <!-- Le fav and touch icons -->
  <!-- Update these with your own images
    <link rel="shortcut icon" href="images/favicon.ico">
    <link rel="apple-touch-icon" href="images/apple-touch-icon.png">
    <link rel="apple-touch-icon" sizes="72x72" href="images/apple-touch-icon-72x72.png">
    <link rel="apple-touch-icon" sizes="114x114" href="images/apple-touch-icon-114x114.png">
  -->

    <!-- atom & rss feed -->
    <link href="/atom.xml" type="application/atom+xml" rel="alternate" title="Sitewide ATOM Feed">
    <link href="/rss.xml" type="application/rss+xml" rel="alternate" title="Sitewide RSS Feed">

  </head>

  <body>
    <div class="navbar">
      <div class="navbar-inner">
        <div class="container-narrow">
          <a class="brand" href="/">dogeyes</a>
          <ul class="nav">
            
            
            


  
    
      
      	
      	<li><a href="/archive.html">Archive</a></li>
      	
      
    
  
    
      
    
  
    
      
      	
      	<li><a href="/categories.html">Categories</a></li>
      	
      
    
  
    
      
    
  
    
      
      	
      	<li><a href="/pages.html">Pages</a></li>
      	
      
    
  
    
      
    
  
    
      
    
  
    
      
      	
      	<li><a href="/tags.html">Tags</a></li>
      	
      
    
  



          </ul>
        </div>
      </div>
    </div>

    <div class="container-narrow">

      <div class="content">
        
<div class="page-header">
  <h1>使用数据库 chapter23 LCLSS </h1>
</div>

<div class="row-fluid post-full">
  <div class="span12">
    <div class="date">
      <span>04 February 2013</strong>
    </div>
    <div class="content">
      <h1>第23章 使用数据库</h1>

<h2>23.1 MySQL数据库</h2>

<h3>23.1.1 安装MySQL</h3>

<p>参考第8章</p>

<h3>23.1.2 MySQL客户端界面</h3>

<p>mysql命令行界面</p>

<h4>1. 连接到服务器</h4>

<hr />

<p>mysql命令行参数</p>

<hr />

<p><code>-u</code> 指定登陆用户名,无该选项用Linux登陆名进行尝试</p>

<p><code>-p</code> 为用户账户提示输入命令</p>

<h4>2. mysql命令</h4>

<p>两类命令</p>

<ul>
<li>特殊的mysql命令</li>
<li>标准SQL语句</li>
</ul>


<hr />

<p>mysql命令</p>

<hr />

<p>简写命令或完整命令</p>

<pre><code>\s #status 服务器状态信息
</code></pre>

<p>MySQL支持所有标准SQL(Structured Query Language, 结构化查询语言)命令</p>

<p>如</p>

<p><code>SHOW</code>命令, 提取关于MySQL的信息</p>

<pre><code>SHOW DATABASES;
#显示数据库
USE mysql;
#连接到单个数据库mysql
</code></pre>

<p>注意命令以<code>;</code>结尾</p>

<pre><code>SHOW TABLES;
#显示表
</code></pre>

<p>mysql支持大写或者小写指定SQL命令,但是通用方式是大写字母</p>

<h3>23.1.3 创建MySQL数据库对象</h3>

<ul>
<li>存储应用数据的唯一数据库;</li>
<li>从脚本中访问数据库的唯一用户账户</li>
<li>组织数据的一个或多个数据表</li>
</ul>


<h4>1. 创建数据库</h4>

<p>创建一个新的数据库</p>

<pre><code>CREATE DATABASE name;
</code></pre>

<p>必须有创建数据库的权限</p>

<pre><code>SHOW DATABASES;
#查看
USE test;
#使用
</code></pre>

<h4>2. 创建用户账户</h4>

<p><code>GRANT</code> SQL语句</p>

<pre><code>GRANT SELECT,INSERT,DELETE,UPDATE ON test.* TO test IDENTIFIED by 'test'
</code></pre>

<p>第一部分定义了用户账户对那些数据库有哪些权限(查询(select权限),插入,删除以及更新)</p>

<p>test.*项定义了权限作用的数据库和表,通过下面格式指定</p>

<pre><code>database.table
</code></pre>

<p>test.*表示权限在test数据库的所有表上</p>

<p>最后指定权限作用的用户账户,如果账户不存在,会直接创建账户</p>

<p>identified by部分为新用户账户设定默认密码</p>

<pre><code>mysql test -u test -p
测试test数据库的test用户
</code></pre>

<h2>23.2 PostgreSQL 数据库</h2>

<h3>23.2.1 安装PostgreSQl</h3>

<p>PostgreSQL的系统管理员账户称为postgres,而不是root</p>

<p>PostgreSQL也支持在内部维护自己的用户数据库,但是大多数都会利用现有的Linux系统用户账户来认证PostgreSQL用户</p>

<p>系统上必须有一个叫做postgres的用户账户</p>

<h3>23.2.2 PostgreSQL命令行界面</h3>

<p><code>psql</code></p>

<h4>1. 连接服务器</h4>

<hr />

<p>psql命令行参数</p>

<hr />

<pre><code>sudo -u postgres psql
#非postgres用户登陆数据库的postgres账户
</code></pre>

<h4>2. psql命令</h4>

<ul>
<li>标准SQL语句</li>
<li><p>PostgreSQL元命令</p></li>
<li><p>\l   列出所有数据库</p></li>
<li>\c   连接到数据库</li>
<li>\dt  列出数据库中的表</li>
<li>\du  列出PostgreSQL用户</li>
<li>\z   列出表的权限</li>
<li>\?   列出所有可能的元命令</li>
<li>\h   列出所有可能的SQL命令</li>
<li>\q   退出数据库</li>
</ul>


<h3>23.2.3 创建PostgreSQL数据库对象</h3>

<h4>1. 创建数据库对象</h4>

<p>用postgres用户创建</p>

<pre><code>CREATE DATABASE test;
</code></pre>

<p>模式(schema),数据库可以有多个模式,每个模式包含多个表,这样允许你根据特定应用或用户将数据库进一步细分</p>

<p>默认每个数据库都有一个模式,成为public</p>

<h4>2. 创建用户账户</h4>

<p>PostgreSQL中的用户账户成为登陆角色(Login Role)</p>

<ul>
<li>创建一个跟PostpreSQL登陆角色对应的特殊Linux账户来运行所有的shell脚本</li>
<li><p>为每个需要运行shell脚本来访问数据库的linux用户账户创建PostgreSQL账户</p>

<p>  CREATE ROLE rich login;</p></li>
</ul>


<p>组角色(group role)</p>

<h2>23.3 使用数据库</h2>

<h3>23.3.1 创建数据表</h3>

<p>关系数据库(relational database)</p>

<p>在关系数据库中,数据由<code>数据字段</code> <code>数据行</code> <code>表</code> 组成</p>

<p>数据字段是单独的一条信息,如员工姓或工资</p>

<p>数据行是相关数据字段的集合,比如员工ID号,姓,名,地址和工资</p>

<p>表含有保存相关数据的所有数据行, 比如一个Employees的表来保存每个员工的数据行</p>

<p>CREATE TABLE; 新建表</p>

<pre><code>CREATE TABLE employees (
empid int not null,   #定义非空
lastname varchar(30),
firstname varchar(30),
salary float,
primary key (empid)); #定义唯一性?
</code></pre>

<p>创建新表前确保你正在正确的数据库中,还要确保你用管理员用户账户</p>

<p>数据类型</p>

<ul>
<li>char     定长字符串值</li>
<li>Varchar  变长字符串值</li>
<li>int      整数值</li>
<li>float    浮点值</li>
<li>Boolean  布尔类型true/false值</li>
<li>Date     YYYY-MM-DD格式的日期值</li>
<li>Time     HH:mm:ss格式的时间值</li>
<li>Timestamp 日期和时间的组合值</li>
<li>Text     长字符串值</li>
<li>BLOB     大的二进制值,比如图片或视频剪辑</li>
</ul>


<p>empid还指定了一个<strong>数据约束(data constraint)</strong>, 数据约束限制输入的什么类型数据可以创建一个有效的数据行, not null 指明每个数据行都必须有一个唯一的empid值</p>

<p>在PostgreSQL为表一级分配权限</p>

<pre><code>GRANT SELECT,INSERT,DELETE,UPDATE ON public public.employees TO rich;
</code></pre>

<h3>23.3.2 插入和删除数据</h3>

<pre><code>INSERT INTO table VALUES (…)

INSERT INTO employees VALUES (1, ' Blum' , ' Rich', 25000.00)
</code></pre>

<p>如果插入两条empid相同的数据会报错</p>

<p>删除数据</p>

<pre><code>DELETE FROM table;
</code></pre>

<p>小心,这个命令删除表中所有数据</p>

<pre><code>DELETE FROM employees WHERE empid = 2
</code></pre>

<h3>23.3.3 查询数据</h3>

<pre><code>SELECT datafields FROM table
</code></pre>

<p>datefields参数使用逗号分开的你希望查询的数据字段名称, 如果要提取所有字段,就用星号通配符</p>

<pre><code>SELECT * FROM employees
</code></pre>

<p>可以加修饰符来定义数据库服务器如何返回查询要找的数据</p>

<ul>
<li>WHERE    显示符合特定条件的数据子集</li>
<li>ORDER BY 以指定顺序显示数据行</li>
<li><p>LIMIT    只显示数据行的一个子集</p>

<p>  SELECT * FROM employees WHERE salary > 40000</p></li>
</ul>


<h2>23.4 在脚本中使用数据库</h2>

<h3>23.4.1 连接到数据库</h3>

<h4>1. 查找客户端程序</h4>

<p><code>which mysql</code> 查找mysql安装的位置</p>

<pre><code>MYSQL=`which mysql`
</code></pre>

<h4>2. 登录到服务器</h4>

<pre><code>MYSQL test -u test -ptest
#直接输入密码,登陆
</code></pre>

<p>但是这样任何能够访问脚本的人都能看到数据库的账号和密码</p>

<p>使用`$HOME/.my.cnf文件来读取特殊的启动命令和设置</p>

<p>在这个文件里面设置默认密码,加入</p>

<pre><code>[client]
password = test
#将文件权限换成400
</code></pre>

<h3>23.4.2 向服务器发送命令</h3>

<ul>
<li>发送单个命令并退出</li>
<li>发送多个命令</li>
</ul>


<p>mysql 的 <code>-e</code>参数</p>

<pre><code>MYSQL=`which mysql`
$MYSQL test -u test -e 'select * from employees'
</code></pre>

<p>psql使用-C参数</p>

<pre><code>PSQL=`which psql`
$PSQL test -c 'select * from employees"
</code></pre>

<p>要发送多条SQL命令使用文件重定向(第14章),在shell脚本中重定向行,必须定义一个结束字符串(end of file string),结束字符串指定了重定向数据的开始和结尾</p>

<pre><code>MYSQL = `which mysql`
$MYSQL test -u test &lt;&lt; EOF
show tables;
select * from employees where salary &gt; 40000;
EOF

PSQL=`which psql`
$PSQL test &lt;&lt; EOF
\dt;
select * from employees where salary &gt; 40000;
EOF
</code></pre>

<h3>23.4.3 格式化数据</h3>

<h4>1. 将输出赋给变量</h4>

<pre><code>dbs=`$MYSQL test -u test -Bse 'show databases'`
for db in $dbs
do
  echo $db
done
</code></pre>

<h4>2. 使用格式化标签</h4>

<p><code>-H</code>选项以HTML格式显示结果选项</p>

<pre><code>psql test -H -C 'select * from  employees where empid = 1'
</code></pre>

<p>mysql还支持扩展标记语言(XML), 使用<code>-X</code>选项</p>

    </div>

  
    <ul class="tag_box inline">
      <li><i class="icon-folder-open"></i></li>
      
      


  
     
    	<li><a href="/categories.html#LCLSS-ref">
    		LCLSS <span>23</span>
    	</a></li>
    
  


    </ul>
    

  
    <ul class="tag_box inline">
      <li><i class="icon-tags"></i></li>
      
      


  
     
    	<li><a href="/tags.html#LCLSS-ref">LCLSS <span>23</span></a></li>
     
    	<li><a href="/tags.html#linux-ref">linux <span>23</span></a></li>
     
    	<li><a href="/tags.html#学习-ref">学习 <span>34</span></a></li>
     
    	<li><a href="/tags.html#command line-ref">command line <span>22</span></a></li>
    
  



    </ul>
    

    <hr>
    <div class="pagination">
      <ul>
      
        <li class="prev"><a href="/LCLSS/2013/02/03/chapter22-lclss" title="使用其他shell chapter22 LCLSS">&larr; Previous</a></li>
      
        <li><a href="/archive.html">Archive</a></li>
      
        <li class="next"><a href="/LCLSS/2013/02/05/chapter26-lclss" title="编写脚本实用工具 chapter26 LCLSS">Next &rarr;</a></li>
      
      </ul>
    </div>
    <hr>
    


  <div id="disqus_thread"></div>
<script type="text/javascript">
    var disqus_developer = 1;
    var disqus_shortname = 'jekyllbootstrap'; // required: replace example with your forum shortname
    
    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">blog comments powered by <span class="logo-disqus">Disqus</span></a>




  </div>
</div>

      </div>
      <hr>
      <footer>
        <p>&copy; 2013 dogeyes
          with help from <a href="http://jekyllbootstrap.com" target="_blank" title="The Definitive Jekyll Blogging Framework">Jekyll Bootstrap</a>
          and <a href="http://twitter.github.com/bootstrap/" target="_blank">Twitter Bootstrap</a>
        </p>
      </footer>

    </div>

    
  </body>
</html>

