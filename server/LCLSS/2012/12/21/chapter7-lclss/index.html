<link href="/assets/themes/twitter/css/pygments.css" rel="stylesheet">

<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>管理文件系统 chapter7 LCLSS</title>
    <meta name="description" content="">
    <meta name="author" content="dogeyes">

    <!-- Enable responsive viewport -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- Le HTML5 shim, for IE6-8 support of HTML elements -->
    <!--[if lt IE 9]>
      <script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->

    <!-- Le styles -->
    <link href="/assets/themes/twitter/bootstrap/css/bootstrap.2.2.2.min.css" rel="stylesheet">
    <link href="/assets/themes/twitter/css/style.css?body=1" rel="stylesheet" type="text/css" media="all">

    <!-- Le fav and touch icons -->
  <!-- Update these with your own images
    <link rel="shortcut icon" href="images/favicon.ico">
    <link rel="apple-touch-icon" href="images/apple-touch-icon.png">
    <link rel="apple-touch-icon" sizes="72x72" href="images/apple-touch-icon-72x72.png">
    <link rel="apple-touch-icon" sizes="114x114" href="images/apple-touch-icon-114x114.png">
  -->

    <!-- atom & rss feed -->
    <link href="/atom.xml" type="application/atom+xml" rel="alternate" title="Sitewide ATOM Feed">
    <link href="/rss.xml" type="application/rss+xml" rel="alternate" title="Sitewide RSS Feed">

  </head>

  <body>
    <div class="navbar">
      <div class="navbar-inner">
        <div class="container-narrow">
          <a class="brand" href="/">dogeyes</a>
          <ul class="nav">
            
            
            


  
    
      
      	
      	<li><a href="/archive.html">Archive</a></li>
      	
      
    
  
    
      
    
  
    
      
      	
      	<li><a href="/categories.html">Categories</a></li>
      	
      
    
  
    
      
    
  
    
      
      	
      	<li><a href="/pages.html">Pages</a></li>
      	
      
    
  
    
      
    
  
    
      
    
  
    
      
      	
      	<li><a href="/tags.html">Tags</a></li>
      	
      
    
  



          </ul>
        </div>
      </div>
    </div>

    <div class="container-narrow">

      <div class="content">
        
<div class="page-header">
  <h1>管理文件系统 chapter7 LCLSS </h1>
</div>

<div class="row-fluid post-full">
  <div class="span12">
    <div class="date">
      <span>21 December 2012</strong>
    </div>
    <div class="content">
      <h1>第7章 管理文件系统</h1>

<h2>7.1 探索Linux文件系统</h2>

<p>Linux支持多种类型的文件系统来管理文件和目录</p>

<h3>7.1.1 基本的Linux文件系统</h3>

<h4>1. ext文件系统</h4>

<p>扩展文件系统(extended filesystem, ext)</p>

<p>使用虚拟目录来操作硬件设备,在物理设备上按定长的块来存储数据</p>

<p>ext文件系统采用<strong>索引节点</strong>来存放虚拟目录中所存储文件的信息</p>

<p>索引节点系统在每个物理设备中创建一个单独的表(索引节点表)来存储这些文件的信息.存储在虚拟目录中的每一个文件在索引节点表中都有一个条目.条目名称的扩展部分来自其跟踪每个文件的课外数据,包括:</p>

<ul>
<li>文件名</li>
<li>文件大小</li>
<li>文件的属主</li>
<li>文件的属组</li>
<li>文件的访问权限</li>
<li>指向存有文件数据的每个硬盘块的指针</li>
</ul>


<p>Linux通过唯一的数值(索引节点号)来引用索引节点表中的每个索引节点,这个值在创建时由文件系统分配,文件系统通过索引节点号而不是文件全名及路径来标识文件</p>

<h4>2. ext2文件系统</h4>

<p>ext文件大小不能超过2GB,ext升级到第二扩展文件系统,ext2</p>

<p>ext2是ext基本功能的一个扩展, 扩展了索引节点表的格式来保存系统上每个文件的更多信息</p>

<p>添加了创建时间值,修改时间值,最后访问时间值来帮助系统管理员追踪文件的访问情况,最大文件大小增加到2TB(后期版本增加到32TB)</p>

<p>ext2还改变了文件在数据块中存储的方式. ext文件系统常见的问题是在文件写入物理设备时,存储数据用的块很容易就分散在整个设备上(碎片化),降低文件系统的性能. ext2通过按组分配磁盘块来减轻碎片化,通过数据块分组,文件系统就不需要为了数据块查找整个物理设备来读取文件</p>

<p>ext文件系统脆弱,每次存储或更新文件,要用新信息来更新索引节点表,但是并不是连成一气的,在存储文件和更新索引节点表的过程中,计算机系统发生了什么事情,这二者就不同步了</p>

<h3>7.1.2 日志文件系统</h3>

<p>取代了先将数据直接写入存储设备再更新索引节点表的作法</p>

<p>日志文件系统会先将文件的更改写入临时文件(日志,journal)中,然后在数据成功写到存储设备和索引节点表之后,再删除对应的日志条目.</p>

<p>如果系统在数据被写入到存储设备之前崩溃了或断电了,日志文件系统下次会读取日志文件并处理上次留下的未写入的数据</p>

<p>3种日志 方法</p>

<ul>
<li>数据模式</li>
<li>排序模式</li>
<li>回写模式</li>
</ul>


<h3>7.1.3 扩展的Linux日志文件系统</h3>

<p>与ext2文件系统兼容,并且可以转换</p>

<h4>1 ext3 文件系统</h4>

<p>采用和ext2文件系统相同的索引节点结构,但是给每个设备增加了一个日志文件</p>

<p>默认使用排序模式</p>

<p>ext3 仍然缺一些东西,比如无法恢复误删的文件,没有内建的数据压缩功能,也不支持加密文件</p>

<h4>2 ext4 文件系统</h4>

<p>除了支持数据压缩和加密,ext4还支持一个称作<strong>区段(extent)</strong>的特性. 区段在存储设备上按块分配空间, 但在索引节点表总只保存起始块的位置,无需列出所有用来存储文件中数据的数据块,可以在索引节点表中节省一些空间</p>

<p>ext4 还整合了<strong>块预分配(block preallocation)</strong> ,如果你想在存储上给一个你知道要变大的文件预留空间,通过ext4文件系统你可以为文件分配所有期望的块,不只是物理上存在的块,ext4文件系统用0填满预留的数据块,并知道不要将它们分配给其他文件</p>

<p>如何加密,压缩,恢复, 我比较好奇</p>

<h4>3 Reiser文件系统</h4>

<p>ReiserFS, 只支持回写日志模式, Linux上最快的日志文件系统之一.</p>

<ul>
<li>可以在线调整已有文件系统的大小.</li>
<li>尾部压缩(tail packing)技术, 可以将一个文件的数据填进另一个文件的数据块中的空白空间</li>
</ul>


<h4>4 JFS 文件系统</h4>

<p>JFS(Journaled File System, 日志文件系统)</p>

<p>排序日志模式</p>

<p>基于区段的文件分配</p>

<h4>5 XFS文件系统</h4>

<p>回写日志模式</p>

<h2>7.2 操作文件系统</h2>

<h3>7.2.1 创建分区</h3>

<p>分区可以是整个硬盘,也可以是硬盘的一部分,来容纳虚拟目录的一部分</p>

<p><code>fdisk</code> 工具用来帮助安装管理在系统上的任何存储设备上的分区</p>

<p>启动<code>fdisk</code> 命令,要指定分区的存储设备的设备名</p>

<pre><code>sudo fdisk /dev/sdc
</code></pre>

<p>第一次给存储设备分区,会警告设备上没有分区表</p>

<hr />

<p>fdisk命令</p>

<hr />

<p><code>fdisk 分区设备名</code> 进入交互式</p>

<p><strong>主分区(primary partition)</strong> 或者 <strong>扩展分区(extended partition)</strong></p>

<p>主分区可以被文件系统直接格式化,扩展分区只能容纳其他主分区,扩展分区出现的原因是每个存储设备上只能有4个分区,可以创建多个扩展分区,然后在扩展分区内创建主分区来进行扩展</p>

<p>IDE硬盘 /dev/hdx x为a,b,c等</p>

<p>SATA和SCSI硬盘 /dev/sdx  x为a,b,c等</p>

<p>格式化分区之前,要再三检查,保证正确</p>

<h3>7.2.2 创建文件系统</h3>

<p>数据存储到分区之前,先要用文件系统格式化它,这样才能用,不同格式用不同的命令行程序来格式化</p>

<ul>
<li>mkefs ext文件系统</li>
<li>mke2fs ext2文件系统</li>
<li>mkfs.ext3 ext3文件系统</li>
<li>mkfs.ext4 ext4文件系统</li>
<li>mkreiserfs ReiserFS文件系统</li>
<li>jfs_mkfs JFS文件系统</li>
<li>mkfs.xfd XFS文件系统</li>
</ul>


<p>未分区创建文件系统后,下一步是要将它挂载到虚拟目录下的某个挂载点,这样就可以将数据存储在新文件,可以将新文件系统挂载到虚拟目录中需要额外空间的任何位置.</p>

<p>挂载当然还是<code>mount</code> 命令</p>

<p>用mount只是临时挂载文件系统,重启后不会自动挂载,要强制在启动时自动挂载,可以就爱那个文件系统添加到/etc/fstab文件总</p>

<h3>7.2.3 如果出错了</h3>

<p>每个文件系统都有自己的和文件系统交互的恢复命令</p>

<p><code>fsck</code>命令用来检查和修复任意类型的Linux文件系统</p>

<p><code>fsck options filesystem</code></p>

<p>文件系统可以通过设备名,虚拟目录挂载点,分配给文件系统的唯一UUID值来引用</p>

<p><code>fsck</code>命令使用<code>/etc/fstab</code> 文件来决定挂载到系统上的存储设备的文件系统,如果设备通常不挂载,使用<code>-t</code>  选项来指定文件系统类型.</p>

<hr />

<p>fsck的命令行选项</p>

<hr />

<p>只能在为挂载的文件系统上运行fsck命令,对于大多数文件系统,只需卸载文件系统来进行检查,完成了重新挂载就好了,但是根文件系统含有所有核心的Linux命令和日志文件,不能在运行的系统上卸载它,这时使用Linux LiveCD 是个好时机</p>

<h2>7.3 逻辑卷管理器</h2>

<p>Linux逻辑卷管理器(Logical Volume Manager, LVM), 无需重新构建整个文件系统而操作硬盘空间</p>

<h3>7.3.1 逻辑卷管理布局</h3>

<p>在逻辑卷管理的世界里,硬盘称为<strong>物理卷(Physical Volume, PV)</strong>, 每个物理卷都会映射到硬盘上创建的某个物理分区</p>

<p>多个物理卷元素集中到一起可以组成一个<strong>卷组(Volume Group, VG)</strong>. 逻辑卷管理系统会把卷组当做物理硬盘一样对待,但事实上卷组可能是由分布在多个物理硬盘上的多个物理分区组成的.卷组提供了一个创建逻辑分区的平台,而这些逻辑分区事实上包含了文件系统</p>

<p>整个结构中的最后一层是<strong>逻辑卷(Logical Volume, LV)</strong>, 为Linux提供了创建文件系统的分区环境, 作用类似于之前讨论的物理硬盘. Linux将逻辑卷当成物理分区对待,可以用任意一种标准Linux文件系统来格式化逻辑卷,再将它在某个挂载点添加进Linux虚拟目录中</p>

<hr />

<p>逻辑卷管理环境 这图值得研究</p>

<hr />

<h3>7.3.2 Linux的LVM</h3>

<ul>
<li>LVM1</li>
<li>LVM2</li>
</ul>


<p>LVM2还提供了额外的功能</p>

<h4>1. 快照</h4>

<p>将一个已有逻辑卷在逻辑卷在线的状态下复制到另一个设备</p>

<p>LVM1只允许创建只读快照</p>

<p>LVM2 允许创建在线逻辑卷的可读写快照</p>

<p>这个功能对快速故障转移或要修改数据的程序实验(一旦失败,就要重启系统)非常有用</p>

<h4>2. 条带化</h4>

<p><strong>条带化(striping)</strong>, 有了条带化课跨多个物理硬盘创建逻辑卷,当Linux LVM将文件写入逻辑卷时, 文件总的数据块会被分散到多个硬盘上, 每个后继数据块会被写到下一个硬盘</p>

<p>条带化有助于提高硬盘的性能,可以将一个文件的多个数据块同时些入多个硬盘,读取数据也可以从多个硬盘读取</p>

<h4>3. 镜像</h4>

<p>和物理分区一样, LVM逻辑卷也会受到断电和硬盘崩溃的影响.</p>

<p>镜像是一个实时更新的逻辑卷的一份完整副本,当穿件镜像逻辑卷时,LVM会将原始逻辑卷同步到镜像副本中</p>

<p>一旦原始同步完成,LVM会为文件系统的每次写过程进行两次写过程--一个写到主逻辑卷,一个写到镜像副本. 当然这个过程会降低系统的写入性能,但是可靠性很高</p>

<h3>7.3.3 使用Linux LVM</h3>

<h4>1. 定义物理卷</h4>

<p>第一步, 将硬盘上的物理分区转换成Linux LVM使用的物理卷区段</p>

<p><code>fdisk</code> 的<code>t</code>命令改变分区类型(8e, 表示分区将会被用作LVM的一部分,而不是直接的文件系统</p>

<p>第二步,用分区来创建真实的物理卷,通过<code>pvcreate</code>命令来完成</p>

<h4>2. 创建卷组</h4>

<p>第三步,从物理卷中创建一个或多个卷组, 卷组数量没有限制</p>

<p><code>vgcreate Vol1 /dev/sdc1</code> 命令创建卷组Vol1</p>

<p><code>vgdisplay</code> 显示卷组的细节</p>

<h4>3. 创建逻辑卷组</h4>

<p>逻辑卷是Linux系统用来模拟物理分区以及保存文件系统的, Linux系统会像处理物理分区一样处理逻辑卷,允许定义逻辑卷中的文件系统,然后将文件系统挂载到虚拟目录上</p>

<p><code>lvcreate</code> 创建逻辑卷</p>

<hr />

<p>lvcreate的选项</p>

<hr />

<p><code>lvdisplay</code> 查看创建的逻辑卷的信息情况</p>

<p><code>-l</code> 参数指定了要使用的逻辑卷占卷组的空闲空间</p>

<p><code>-n</code> 指定逻辑卷的名称</p>

<h4>4. 创建文件系统</h4>

<p>要做文件系统,使用创建文件系统对应的命令行程序<code>mfs.ext4</code>之类的</p>

<p>创建完成后可以使用mount来挂载</p>

<p>路径使用卷组名和逻辑卷名一起来标识,而不是用物理分区的路径.</p>

<h4>5. 修改LVM</h4>

<p>LVM可以动态修改文件系统</p>

<ul>
<li>vgchange 激活和禁用卷组</li>
<li>vgremove 删除卷组</li>
<li>vgextent 将物理卷加到卷组中</li>
<li>vgreduce 从卷组总删除物理卷</li>
<li>lvexend 增加逻辑卷的大小</li>
<li>lvreduce 减小逻辑卷的大小</li>
</ul>


<p>在手动增加或者减小逻辑卷的大小时,要小心,存储在逻辑卷中的文件系统需要手动修复来处理大小上的改变,大多数文件系统包含重新调整文件系统格式的命令行程序,比如ext2和ext3的resize2fs程序</p>

    </div>

  
    <ul class="tag_box inline">
      <li><i class="icon-folder-open"></i></li>
      
      


  
     
    	<li><a href="/categories.html#LCLSS-ref">
    		LCLSS <span>23</span>
    	</a></li>
    
  


    </ul>
    

  
    <ul class="tag_box inline">
      <li><i class="icon-tags"></i></li>
      
      


  
     
    	<li><a href="/tags.html#LCLSS-ref">LCLSS <span>23</span></a></li>
     
    	<li><a href="/tags.html#学习-ref">学习 <span>34</span></a></li>
     
    	<li><a href="/tags.html#command line-ref">command line <span>22</span></a></li>
     
    	<li><a href="/tags.html#linux-ref">linux <span>23</span></a></li>
    
  



    </ul>
    

    <hr>
    <div class="pagination">
      <ul>
      
        <li class="prev"><a href="/LCLSS/2012/12/19/chapter6-lclss" title="理解Linux文件权限 chapter6 LCLSS">&larr; Previous</a></li>
      
        <li><a href="/archive.html">Archive</a></li>
      
        <li class="next"><a href="/LCLSS/2012/12/23/chapter8-lclss" title="安装软件程序 chapter8 LCLSS">Next &rarr;</a></li>
      
      </ul>
    </div>
    <hr>
    


  <div id="disqus_thread"></div>
<script type="text/javascript">
    var disqus_developer = 1;
    var disqus_shortname = 'jekyllbootstrap'; // required: replace example with your forum shortname
    
    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">blog comments powered by <span class="logo-disqus">Disqus</span></a>




  </div>
</div>

      </div>
      <hr>
      <footer>
        <p>&copy; 2013 dogeyes
          with help from <a href="http://jekyllbootstrap.com" target="_blank" title="The Definitive Jekyll Blogging Framework">Jekyll Bootstrap</a>
          and <a href="http://twitter.github.com/bootstrap/" target="_blank">Twitter Bootstrap</a>
        </p>
      </footer>

    </div>

    
  </body>
</html>

