---
layout: post
title: "理解Linux文件权限 chapter6 LCLSS"
description: ""
category: LCLSS
tags: [LCLSS, linux, command line, 学习]
---
{% include JB/setup %}

# 第6章 理解Linux文件权限

## 6.1 Linux的安全性

Linux安全系统的核心是用户账户,每个进入Linux系统的用户都会被分配一个唯一的用户账户,用户对系统上对象的访问权限取决于他们登录系统时用的账户

用户权限是通过创建用户时分配的**用户ID(User ID, UID)**来跟踪的

每个用户都有唯一的UID,登录时不用UID登录,而用**登录名(login name)**,登录名关联一个对应的密码

### 6.1.1 /etc/passwd文件

文件管理登录名和UID的对应

**root**是系统管理员,UID为0

linux会为各种各样的功能创建不同的用户账户,这些账户不是真正的用户,是**系统账户**,是系统上运行的各种服务进程访问资源用的特殊账户, 所有运行在后台的服务都需要一个系统用户账户登录到Linux系统.

Linux为系统账户预留了500一下的UID值,有些服务甚至要特定的UID才能正常工作.

为不同用户创建账户时,大多数Linux系统会将500起始的第一个可用UID分配给这个账户

/etc/passwd 包含

* 登录用户名
* 用户密码
* 用户账户UID
* 用户账户GID
* 用户账户的文本描述
* 用户的HOME目录位置
* 用户的默认shell

密码显示为x,现在的密码一般保存在另一个单独文件中(shadow文件,/etc/shadow),只有特定的程序才能访问这个文件

虽然/etc/passwd 可以直接编辑,但是最好不要,一旦损坏系统就无法读取他了,甚至连root也无法登陆了.

### 6.1.2 /etc/shadow文件

/etc/shadow 能对Linux系统如何管理密码有更多的控制,只有root可以访问

为系统上的每个用户账户保存了一条记录

    dexctor:$1$lUhhbcOL$udjVN09RCa3YVagoJgGt91:15567:0:99999:7:::
	
9个字段

1. 登录名
2. 加密后的密码
3. 自1970年1月1日(上次修改密码的日期)到当天的天数
4. 多少天后才能修改密码
5. 多少天后必须修改密码
6. 密码过期前提前多少天提醒用户更换密码
7. 密码过期后多少天禁用用户账户
8. 用户账户被禁用的日期
9. 预留字段,给将来使用

### 6.1.3 添加新用户

`useradd` 命令来添加新用户.

有可能在/usr/sbin/useradd,有可能不在PATH下.

`useradd -D` 查看系统默认设置

    GROUP=100     //新用户添加到GID为100的组
	HOME=/home    //HOME目录为/home/loginname
	INACTIVE=-1   //密码过期后不会禁用
	EXPIRE=       //未被设置为某个日期后过期
	SHELL=/bin/sh //bash 作为默认shell
	SKEL=/etc/skel //系统会将/etc/skel目录下的内容复制到HOME下
	CREATE_MAIL_SPOOL=no //不创建mail目录

不在命令行制定,useradd会使用默认设置

倒数第二个配置,useradd允许管理员创建一份默认的HOME目录配置,然后把它作为创建新用户HOME目录的模板.

默认useradd不创建HOME目录,`-m`选项会叫他创建HOME目录

要想在创建用户时改变默认值或默认行为,可以使用命令行参数

***
useradd命令行参数
***

修改默认值`useradd -D 参数`

    `useradd -D -s /bin/tsch` 默认shell改为tsch
	
### 6.1.4 删除用户

`userdel` 删除用户

默认情况只是删除/ect/passwd文件总的用户信息,而不会删除属于该账户的任何文件

`-r`参数,删除HOME和mail目录, 然而系统上仍然可能存在归已删除用户所有的文件,这有可能导致问题

### 6.1.5 修改用户

* usermod 修改用户账户字段,并可以指定主要组以及附加组的所属关系
* passwd 改密码
* chpasswd 从文件中读取登录名密码对,并更新密码
* chage 修改密码的过期日期
* chfn 修改用户账户的备注信息
* chsh 修改默认shell

#### 1 usermod

可以修改/etc/passwd 中的大部分字段

`-c` 修改备注字段

`-e` 修改过期日期

`-g` 修改默认登录组

`-l` 修改用户账户的登录名

`-L` 锁定用户账户, 这样用户就无法登录了

`-p` 修改密码

`-U` 解出锁定

#### 2 passwd和chpasswd

`passwd test` 修改test用户的密码

无参数是修改当前用户的密码

`-e` 选项能强制用户下次登录时修改密码, 可以先给用户设置一个简单的密码,再让他下次登录时改成更复杂的密码

若要为系统中的大量用户来修改密码, chpasswd命令能让事情变简单,`chpasswd`能从标准输入读取登录名和密码对(冒号分割)列表,给密码加密.也可用重定向

#### 3 chsh, chfn 和 chage

`chsh` 修改默认的shell, 要用shell的完整路径

`chfn` 提供了在/etc/passwd文件备注字段中存储信息的标准方法,`chfn`会将`finger`命令用到的信息存进备注字段.

`finger` 可以简单的查看Linux系统的用户信息,但是处于安全性考虑,这个命令一般会被禁

`chage` 命令帮助用户管理用户账户的有效期

* YYYY-MM-DD格式日期
* 从1970.1.1 到该日期的天数的数值

用`chage`可以设定临时用户,到日期后就失效

## 6.2 使用Linux组

**组(Group)** 在一组用户共享资源时使用有效

组权限允许多个用户共享一组共用的权限来访问系统上的对象,比如文件,目录,设备

每个组有一个唯一的GID,和唯一的组名

### 6.2.1 /etc/group文件

`/etc/group包含系统上的每个组的信息

系统账户的组通常会分配低于500的GID,而用户组从500开始分配

* 组名
* 组密码
* GID
* 属于该组的用户列表(要小心的是并不是所有用户都会列在这里,如果/etc/passwd文件中制定某个组作为默认组时,用户账户不会作为该组的成员再次出现在/etc/group文件中.)

组密码允许非组内成员通过它临时性的称为该组成员,但这个功能不常用

不要直接修改/etc/group文件来添加用户到一个组,而要用usermod.

在添加用户到组之前,先要创建组

### 6.2.2 创建新组

`groupadd` 创建新组

创建新组时,默认没有用户属于该组成员,groupadd没有提供将用户添加到组的选项,但是可以用`usermod`命令将用户添加到组

`usermod -G test dexctor` 将dexctor,添加到test

如果更改已登录系统账户的所属用户组,重新登录后,组关系才会生效

将组添加到用户账户要格外小心,如果加了`-g`参数,那么默认组将被替换,而`-G`将该组添加到用户的属组列表,不会影响默认组

### 6.2.3 修改组

`groupmod` 修改已有组的GID`-g`参数,或组名`-n`参数

修改组名,GID和成员不变,只有组名改变,所有安全权限都是基于GID的,可以随意修改组名而不会影响文件的安全性(*那么修改GID呢?*)

## 6.3 理解文件权限

### 6.3.1 使用文件权限符

`ls -l` 第一个字段是描述文件和目录权限的码

* `-` 代表文件
* `d` 代表目录
* `l` 代表链接
* `c` 代表字符型设备
* `b` 代表块设备
* `n` 代表网络设备

* `r` 代表对象是可读的
* `w` 代表对象是可写的
* `x` 代表对象是可执行的

没有某种权限,会出现单破折号

三组三字码分别对应对象的3个安全级别

* 对象的属主
* 对象的属组
* 系统其他用户

    -rwxrwxr-x 1 rich rich 4882 2010-09-18 13:58 myprog
	
* rwx: 文件的属主(设为登录名rich)
* rwx: 文件的属组(设为组名rich)
* r-x: 系统其他人

rich用户可读可写可执行文件,rich组用户可读可写可执行文件,其他可读可执行

### 6.3.2 默认文件权限

`umask` 设置用户创建文件和目录的默认权限

`umask` 可以显示和设置这个默认权限

    umake
	0022

第一位代表了一项特别的安全特性,叫做**粘着位(sticky bit)**

后面三位表示文件或目录umask的八进制值.

但是为什么新建文件的权限是644呢?

umask值只是个掩码,它会屏蔽掉不想授予该安全级别的权限,umask值会从对象的全权限中减掉,对文件来说全权限是666,对目录来说全权限是77

umask通常设定在/etc/profile启动文件中,也可通过umask命令设置

`umask 026`  将umask设定为026

## 6.4 改变安全性设置

### 6.4.1 改变权限

`chmod options mode file` 改变文件和目录的安全性设置

mode参数后可跟八进制模式或符号模式来设置安全性设置

    chmod 760 newfile
	
将newfile权限改为760

符号权限就比较麻烦了

`[ugoa...][[+-=][rwxXstugo...]`

* u 代表用户
* g 代表组
* o 代表其他
* a 代表所有

* + 增加权限
* - 移除权限
* = 设定权限

* X 如果对象是目录或者它已有执行权限,赋予执行权限
* s 运行时重设UID或GID **重要**
* t 保留问及或目录
* u 将权限设置为跟属主一样
* g 将权限设置为跟属组一样
* o 将权限设置为跟其他用户一样

    chmod o+r newfile  other增加读权限
	
	chmod u-r newfile  user移除读权限
	
`options` 参数为chmod命令提供额外的功能, `-R`参数可以让权限的改变递归的作用到文件和子目录


### 6.4.2 改变所属关系

`chown` 改变属主 

`chgrp` 改变默认属组

`chown options owner[.group] file` 

chown也同时支持改变文件属组,加.group

`chown .rich newfile` 改变目录的默认属组

`chown rich. newfile` 改变目录属主和属组为rich

`-R` 递归改变子目录和文件

`-h`参数改变该文件所有符号链接文件的所属关系

只有root能改属主, 属主可以改属组,但是属主必须属于源和目标属组

`chgrp group file` 改变属组

## 6.5 共享文件

创建组是Linux系统上共享文件访问权限的方法

改变文件的属组,或者将用户加到文件属组, 不一定,还有更好的方法

* 设置用户ID(SUID) 当文件被用户使用时,程序会以文件属主的权限运行
* 设置组ID(SGID) 对文件来说,程序会以文件属组的权限运行,对目录来说,目录创建的新文件会以目录的默认属主作为默认属主
* 粘着位, 进程结束后文件还会在内存中

**SGID** 对文件共享非常重要,使能SGID位, 在共享目录下创建的新文件属于该目录的属组,也就是每个用户的组

SGID 通过chmod命令设置,加到标准3位8进制之前(组成4位8进制),或者在符号模式下使用符号s

  1    2     3
SUID SGID 粘着位

共享文件

1. 创建共享目录
2. chgrp 默认属组改为含有所有所需共享文件用户的组
3. 设置目录的SGID 为,新建文件以共享组为属组

为了能正常工作,要把umask设为属组可写
